name: üõ°Ô∏è Accessibility Testing

permissions:
  contents: read
  issues: write
  pull-requests: write

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run accessibility tests daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - staging
          - production

env:
  NODE_VERSION: '22'
  PNPM_VERSION: '10'

jobs:
  accessibility-tests:
    name: üß™ Accessibility Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    strategy:
      matrix:
        test-type: [axe-core, lighthouse, custom]
        
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: üì¶ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: üì¶ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: üèóÔ∏è Build application
        run: pnpm build

      - name: üöÄ Start development server
        run: |
          pnpm dev &
          # Wait for the dev server to become available (max ~60 s)
          for i in {1..30}; do
            sleep 2
            if curl -sf http://localhost:4321 > /dev/null; then
              echo "‚úÖ Server is up!"
              break
            fi
            echo "‚è≥ Waiting for server... ($i/30)"
            if [ $i -eq 30 ]; then
              echo "‚ùå Server did not start in time" >&2
              exit 1
            fi
          done
        env:
          CI: true

      - name: üß™ Run Axe-Core Tests
        if: matrix.test-type == 'axe-core'
        run: |
          pnpm axe:scan
          pnpm test:accessibility:ci
        continue-on-error: true

      - name: üß™ Run Lighthouse Tests
        if: matrix.test-type == 'lighthouse'
        run: |
          pnpm lighthouse:accessibility
        continue-on-error: true

      - name: üß™ Run Custom Accessibility Tests
        if: matrix.test-type == 'custom'
        run: |
          pnpm test:accessibility:verbose
        continue-on-error: true

      - name: üìä Upload Accessibility Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: accessibility-reports-${{ matrix.test-type }}
          path: |
            accessibility-reports/
            lighthouse-report.html
          retention-days: 30

      - name: üìù Comment PR with Results
        if: github.event_name == 'pull_request' && matrix.test-type == 'axe-core'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Read accessibility report
            let reportContent = '## üõ°Ô∏è Accessibility Test Results\n\n';
            
            try {
              const reportFiles = fs.readdirSync('accessibility-reports');
              const summaryFile = reportFiles.find(f => f.includes('summary'));
              
              if (summaryFile) {
                const summaryPath = path.join('accessibility-reports', summaryFile);
                const summary = fs.readFileSync(summaryPath, 'utf8');
                reportContent += '```\n' + summary + '\n```\n';
              }
              
              reportContent += '\nüìÅ Full reports available in workflow artifacts.';
              
            } catch (error) {
              reportContent += '‚ùå Unable to read accessibility report.';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: reportContent
            });

  accessibility-monitoring:
    name: üìà Accessibility Monitoring
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: accessibility-tests
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: üì¶ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: üì¶ Install dependencies
        run: pnpm install --frozen-lockfile 

      - name: üìä Generate Accessibility Trends
        run: |
          # Create trends directory if it doesn't exist
          mkdir -p accessibility-trends
          
          # Generate trend data (simplified example)
          echo "$(date): Accessibility tests completed" >> accessibility-trends/history.log
        
      - name: üì§ Upload Trends Data
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-trends
          path: accessibility-trends/
          retention-days: 90

      - name: üö® Send Slack Notification
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#accessibility-alerts'
          text: 'üö® Accessibility tests failed on main branch'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  security-accessibility-scan:
    name: üîí Security & Accessibility Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üîç Run CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: javascript

      - name: üîç Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

      # Ensure Node.js and pnpm are available for the security audit step
      - name: üì¶ Setup Node.js for Security Scan
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: üì¶ Install pnpm
        run: npm install -g pnpm@10.11.0

      - name: üõ°Ô∏è Run Security Audit
        run: |
          pnpm audit --audit-level moderate
          
      - name: üß™ Accessibility Security Check
        run: |
          # Check for common accessibility security issues
          echo "Checking for accessibility-related security vulnerabilities..."
          
          # Check for XSS vulnerabilities in ARIA labels
          grep -r "aria-label.*innerHTML\|aria-describedby.*innerHTML" src/ || echo "No innerHTML in ARIA attributes found"
          
          # Check for unsafe focus management
          grep -r "eval\|Function.*focus\|setTimeout.*focus" src/ || echo "No unsafe focus management found"

  performance-accessibility:
    name: ‚ö° Performance Impact on Accessibility
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: üì¶ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: üì¶ Install dependencies
        run: pnpm install --frozen-lockfile 

      - name: üèóÔ∏è Build application
        run: pnpm build

      - name: üöÄ Start server
        run: |
          pnpm exec sirv ./dist --single --dev --port 4321 &
          # Wait for the preview server to become available (max ~60 s)
          for i in {1..30}; do
            sleep 2
            if curl -sf http://localhost:4321 > /dev/null; then
              echo "‚úÖ Server is up!"
              break
            fi
            echo "‚è≥ Waiting for server... ($i/30)"
            if [ $i -eq 30 ]; then
              echo "‚ùå Server did not start in time" >&2
              exit 1
            fi
          done

      - name: ‚ö° Run Performance Tests with Accessibility Focus
        run: |
          npx lighthouse http://localhost:4321 \
            --only-categories=accessibility,performance \
            --output=json \
            --output-path=./lighthouse-perf-a11y.json \
            --chrome-flags="--headless --no-sandbox --disable-dev-shm-usage"

      - name: üìä Analyze Performance Impact
        run: |
          # Analyze if performance optimizations affect accessibility
          node -e "
            const report = require('./lighthouse-perf-a11y.json');
            const a11yScore = report.categories.accessibility.score * 100;
            const perfScore = report.categories.performance.score * 100;
            
            console.log('Accessibility Score:', a11yScore);
            console.log('Performance Score:', perfScore);
            
            if (a11yScore < 95) {
              console.error('‚ùå Accessibility score below threshold');
              process.exit(1);
            }
            
            if (perfScore < 90) {
              console.warn('‚ö†Ô∏è Performance score below optimal');
            }
          "

      - name: üì§ Upload Performance Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-accessibility-report
          path: lighthouse-perf-a11y.json

  mobile-accessibility:
    name: üì± Mobile Accessibility Testing
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: üì¶ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: üì¶ Install dependencies
        run: pnpm install --frozen-lockfile 

      - name: üèóÔ∏è Build application
        run: pnpm build

      - name: üöÄ Start server
        run: |
          pnpm exec sirv ./dist --single --dev --port 4321 &
          # Wait for the preview server to become available (max ~60 s)
          for i in {1..30}; do
            sleep 2
            if curl -sf http://localhost:4321 > /dev/null; then
              echo "‚úÖ Server is up!"
              break
            fi
            echo "‚è≥ Waiting for server... ($i/30)"
            if [ $i -eq 30 ]; then
              echo "‚ùå Server did not start in time" >&2
              exit 1
            fi
          done

      - name: üì± Test Mobile Accessibility
        run: |
          # Test with mobile viewport
          npx lighthouse http://localhost:4321 \
            --only-categories=accessibility \
            --form-factor=mobile \
            --screenEmulation.mobile=true \
            --screenEmulation.width=375 \
            --screenEmulation.height=667 \
            --output=json \
            --output-path=./mobile-a11y.json \
            --chrome-flags="--headless --no-sandbox --disable-dev-shm-usage"

      - name: üìä Analyze Mobile Results
        run: |
          node -e "
            const report = require('./mobile-a11y.json');
            const score = report.categories.accessibility.score * 100;
            console.log('Mobile Accessibility Score:', score);
            
            if (score < 95) {
              console.error('‚ùå Mobile accessibility score below threshold');
              process.exit(1);
            }
          "

      - name: üì§ Upload Mobile Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mobile-accessibility-report
          path: mobile-a11y.json

  accessibility-regression:
    name: üîÑ Accessibility Regression Testing
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: üì• Checkout PR branch
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: üì¶ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: üì¶ Install dependencies
        run: pnpm install --frozen-lockfile 

      - name: üß™ Run Current Branch Tests
        run: |
          pnpm build
          pnpm exec sirv ./dist --single --dev --port 4321 &
          # Wait for the preview server to become available (max ~60 s)
          for i in {1..30}; do
            sleep 2
            if curl -sf http://localhost:4321 > /dev/null; then
              echo "‚úÖ Server is up!"
              break
            fi
            echo "‚è≥ Waiting for server... ($i/30)"
            if [ $i -eq 30 ]; then
              echo "‚ùå Server did not start in time" >&2
              exit 1
            fi
          done
          pnpm test:accessibility:ci
          cp -r accessibility-reports current-reports

      - name: üì• Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}

      - name: üß™ Run Base Branch Tests
        run: |
          pnpm install --frozen-lockfile 
          pnpm build
          pnpm exec sirv ./dist --single --dev --port 4321 &
          # Wait for the preview server to become available (max ~60 s)
          for i in {1..30}; do
            sleep 2
            if curl -sf http://localhost:4321 > /dev/null; then
              echo "‚úÖ Server is up!"
              break
            fi
            echo "‚è≥ Waiting for server... ($i/30)"
            if [ $i -eq 30 ]; then
              echo "‚ùå Server did not start in time" >&2
              exit 1
            fi
          done
          pnpm test:accessibility:ci
          cp -r accessibility-reports base-reports

      - name: üîç Compare Results
        run: |
          # Simple comparison (in real implementation, you'd use proper diff tools)
          echo "Comparing accessibility results..."
          
          if [ -d "current-reports" ] && [ -d "base-reports" ]; then
            echo "üìä Accessibility regression analysis complete"
            echo "Current reports: $(ls current-reports | wc -l) files"
            echo "Base reports: $(ls base-reports | wc -l) files"
          else
            echo "‚ùå Unable to compare reports"
          fi

      - name: üì§ Upload Comparison
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: accessibility-regression-comparison
          path: |
            current-reports/
            base-reports/ 