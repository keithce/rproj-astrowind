---
import type { GetStaticPaths, InferGetStaticPropsType } from 'astro';
import type { CollectionEntry } from 'astro:content';
import Layout from '~/layouts/PageLayout.astro';
import { getCollection } from 'astro:content';
import { cleanSlug, getPermalink } from '~/utils/permalinks';
import { getNotionEntryTitle } from '~/utils/notion';

export const prerender = true;

export const getStaticPaths = (async () => {
  const entries = await getCollection<'rrresources'>('rrresources');
  return entries.map((entry: CollectionEntry<'rrresources'>) => {
    const name = getNotionEntryTitle(entry);
    const slug = cleanSlug(name);
    return {
      params: { slug },
      props: { entry },
    };
  });
}) satisfies GetStaticPaths;

// Properly typed props using the generic type
type Props = InferGetStaticPropsType<typeof getStaticPaths>;
type RRRendered = { rendered?: { html?: string } };
const { entry } = Astro.props as Props;
const data = entry.data;
const title = data.Name || getNotionEntryTitle(entry) || 'Resource';
const description = data['AI summary'] || data.Source || '';
// Use the actual route slug parameter for canonical URL, fallback to sanitized title if needed
const routeSlug = Astro.params.slug;
const canonical = getPermalink(`/rr-resources/${routeSlug || cleanSlug(title)}`, 'post');
---

<Layout metadata={{ title, description, canonical }}>
  <article class="prose prose-gray dark:prose-invert container mx-auto max-w-3xl px-4 py-8">
    <h1 class="mb-4">{title}</h1>

    {
      data['AI summary'] && (
        <details class="mb-6 rounded-lg border bg-white/60 p-4 dark:bg-gray-900/60">
          <summary class="cursor-pointer text-base font-semibold select-none">AI summary</summary>
          <div class="mt-3 text-base leading-relaxed">{data['AI summary']}</div>
        </details>
      )
    }

    {
      data.Type?.length && (
        <p class="mt-4 text-sm">
          <strong>Type:</strong> {data.Type.join(', ')}
        </p>
      )
    }
    {
      data.Category?.length && (
        <p class="mt-2 text-sm">
          <strong>Category:</strong> {data.Category.join(', ')}
        </p>
      )
    }
    {
      data.Tags?.length && (
        <p class="mt-2 text-sm">
          <strong>Tags:</strong> {data.Tags.join(', ')}
        </p>
      )
    }

    <footer class="mt-10 space-y-4">
      {
        data.Source && (
          <p class="text-sm">
            <strong>Source:</strong>{' '}
            <a
              class="underline underline-offset-2"
              href={data.Source}
              rel="noopener noreferrer"
              target="_blank"
            >
              {data.Source}
            </a>
          </p>
        )
      }

      {
        data.Keywords?.length && (
          <div class="flex flex-wrap gap-2">
            {data.Keywords.map((kw: string) => (
              <span class="bg-brand-100 text-brand-800 dark:bg-brand-900/40 dark:text-brand-100 inline-flex items-center rounded-full px-3 py-1 text-xs font-medium">
                {kw}
              </span>
            ))}
          </div>
        )
      }
    </footer>

    {/* Render Notion page HTML content */}
    {
      (() => {
        const renderedHtml = (entry as RRRendered).rendered?.html;
        return renderedHtml ? <div class="notion-content mt-10" set:html={renderedHtml} /> : null;
      })()
    }
    <div id="debug-rendered-present" style="display:none">
      {(entry as RRRendered).rendered ? '1' : '0'}
    </div>
  </article>
</Layout>
