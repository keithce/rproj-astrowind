---
import Layout from '~/layouts/PageLayout.astro';
import RrSearch from '~/components/resources/ResourceSearch.astro';
import RrFilter from '~/components/resources/ResourceFilter.astro';
import ResourceGrid from '~/components/resources/ResourceGrid.astro';
import { findResourceCategories, findResourceTypes, filterResources } from '~/utils/resources';

// Get URL parameters
const categoryParam = Astro.url.searchParams.get('category');
const typeParam = Astro.url.searchParams.get('type');
const searchQuery = Astro.url.searchParams.get('q');

// Fetch data
const categories = await findResourceCategories();
const types = await findResourceTypes();
let entries = await filterResources({
  category: categoryParam || undefined,
  type: typeParam || undefined,
  search: searchQuery || undefined,
});

// Prepare metadata
const title = 'RR Resources';
const description = 'Curated resources for music production, mixing, mastering, and audio engineering';

// Create dynamic title based on filters
let pageTitle = title;
if (categoryParam) {
  pageTitle += `: ${categoryParam}`;
}
if (typeParam) {
  pageTitle += categoryParam ? ` (${typeParam})` : `: ${typeParam}`;
}
if (searchQuery) {
  pageTitle += `: "${searchQuery}"`;
}
---

<Layout metadata={{ title: pageTitle, description }}>
  <section class="mx-auto max-w-7xl px-4 py-8 sm:px-6 lg:px-8 lg:py-12">
    <div class="mb-8">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between">
        <h1 class="leading-tighter mb-4 text-3xl font-bold tracking-tighter md:mb-0 md:text-4xl">
          {title}
          {categoryParam && <span class="text-primary">: {categoryParam}</span>}
          {typeParam && !categoryParam && <span class="text-primary">: {typeParam}</span>}
          {searchQuery && <span class="text-primary">: "{searchQuery}"</span>}
        </h1>
      </div>

      <p class="text-muted-foreground mt-2 text-lg">
        {description}
      </p>
    </div>

    <div class="grid grid-cols-1 gap-8 md:grid-cols-4">
      <!-- Sidebar -->
      <div class="md:col-span-1">
        <RrSearch class="mb-8" />
        <RrFilter
          categories={categories}
          types={types}
          selectedCategory={categoryParam ?? undefined}
          selectedType={typeParam ?? undefined}
        />
      </div>

      <!-- Main Content -->
      <div class="md:col-span-3">
        <ResourceGrid entries={entries} />
      </div>
    </div>
  </section>
</Layout>
